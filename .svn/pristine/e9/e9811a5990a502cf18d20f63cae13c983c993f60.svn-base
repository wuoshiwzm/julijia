<?php

/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2016/10/8
 * Time: 16:53
 */
class Cart
{

    private static $quoteId;

    //先判断有没有购物车，如果没有新建一个
    static function getCart()
    {


        $userInfo = Session::get('member');

        $cart = Source_Cart_CartInfo::where('user_id', $userInfo->id)->first();

        //购物车数据已经存在
        if ($cart) {
            self::$quoteId = $cart->user_id;
            return true;
        }

        //购物车还不存在，新建一个购物车


        //毫秒数为订单号
        $quote['quote_sn'] = floor(microtime(true)*1000);
        $quote['user_id'] = $userInfo->id;
        $quote['user_group'] = $userInfo->group_id;
        $quote['username'] = $userInfo->name;
        //订单来源 1pc 2wap
        $quote['source'] = 1;

        Source_Cart_CartInfo::create($quote);




    }

    /**
     * @param $entityId 商品ID
     * @param null $guige 商品规格信息 数组形式
     *
     * 添加物品到购物车
     */
    static function addItem($entityId, $quantity, $guigeArr = null)
    {


        //获得商品属性
        $productInfo = Product::getProductById($entityId);
        if (!$productInfo)
            return flase;

        //得到row_id
        $shop_id = $productInfo->shop;
        $rowId = self::getRowId($entityId, $shop_id, $guigeArr);

        //判断是否已经有同类商品
        //没有同样商品 - 生成新商品条目
        if (!self::checkRowId($rowId)) {
            self::addRow($entityId, $quantity, $guigeArr = null, $rowId);

        } else {
            //有同样商品 - 更新商品数量
            self::addQty($rowId, $quantity);
        }

    }

    /**
     * @param $productid 商品ID
     */
    static function removeItem($rowId)
    {
        //
    }

    /**
     * @param array $productids 数组形式传商品ID
     * 确认折扣信息
     */
    static function chkDiscount(array $productids)
    {
        //
    }

    /**
     * @param $productid
     * @param $quantity
     * 更新商品数量 用于更新 不增或减
     */
    static function updateQty($rowId, $quantity)
    {
        //
    }


    /**
     * @param $productid
     * @param $quantity
     * 增加商品数量 用于增减商品数量 不能小于0
     */
    static function addQty($rowId, $quantity)
    {
        //
    }


    /**
     * @param $entityId 商品id
     * @param $quantity 商品数量
     * @param null $guigeArr 商品规格数组
     * @param null $rowId 要增加的行对应的row_id
     * 目前购物车没有要添加的商品， 新增一行
     */
    private static function addRow($entityId, $quantity, $guigeArr = null, $rowId)
    {

        /**
         * product_flat
         * id
         * entity_id
         * attribute_set_id
         * name
         * price
         * url_key
         * weight
         * cost_price
         * preferential_price
         * supplier
         * shop
         * brand
         * price_begin
         * price_end
         * sku
         * keysword
         * meta_desc
         * base_image
         * small_image
         * thumbnail
         * kc_qty
         * category_id
         * desc
         * visibility
         * status
         * tuijian
         *
         *
         * item:
         * id
         * row_id
         * product_id
         * categry_id
         * product_name
         * product_status
         * shop_id
         * sku
         * price
         * weight
         * num
         * guige
         * free_shipping
         * row_total
         * row_wegith
         */
        //获得商品属性

        $productInfo = Product::getProductById($entityId);

        //获取订单Id
        $addInfo['quote_id'] = self::quoteId;

        $addInfo['row_id'] = $rowId;
        $addInfo['product_id'] = $productInfo['id'];
        $addInfo['categry_id'] = $productInfo['categry_id'];
        $addInfo['product_name'] = $productInfo['name'];
        $addInfo['product_status'] = $productInfo['visibility'];
        $addInfo['shop_id'] = $productInfo['shop'];
        $addInfo['sku'] = $productInfo['sku'];
        $addInfo['price'] = $productInfo['price'];
        $addInfo['weight'] = $productInfo['weight'];
        $addInfo['num'] = $quantity;
        $addInfo['guige'] = encode($guigeArr);
        $productInfo['cost_price'] == 0 ? $addInfo['free_shipping'] = 1 : $addInfo['free_shipping'] = 0;

        $addInfo['row_total'] = $productInfo['price'] * $quantity;
        $addInfo['row_wegith'] = $productInfo['weight'] * $quantity;
        $res = Source_Cart_CartItem::create($addInfo);

        //成功为$res = NULL
        return !$res;

    }


    /**
     * @param $rowId 要删除的行对应的row_id
     * 目前购物车没有要添加的商品， 新增一行
     */
    static function remove($rowId)
    {

    }


    /**
     * @param $entityId
     * @param $shopId
     * @param $guige
     * 生成RowId 同一个商品id 同一个shop_id 同一个规格 被当作一种商品， 添加同一种商品时只更新数量
     */
    private static function getRowId($entityId, $shopId, $guige)
    {
        $guige = serialize($guige);
        $rowId = sha1($entityId . $shopId . $guige);
        return $rowId;
    }

    /**
     * @param $rowId 商品编码列
     * 当前是否购物车有该种商品
     * 返回true表示有该产品，返加false表示没有该产品
     */
    private static function checkRowId($rowId)
    {
        $res = Source_Cart_CartItem::where('row_id', $rowId)->count();
        return $res ? true : false;
    }


}
